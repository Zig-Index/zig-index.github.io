---
import Layout from "../layouts/Layout.astro";
import { UserPageClient } from "../components/UserPageClient";
import { loadRegistryData, getRegistryStats } from "../lib/registryLoader";

const siteUrl = "https://zig-index.github.io";

// Load all registry entries at build time
const registryEntries = await loadRegistryData();
const stats = getRegistryStats(registryEntries);

// Get unique contributors
const uniqueOwners = [...new Set(registryEntries.map(e => e.owner))];

// Get username from URL if available (for SSR)
const url = new URL(Astro.request.url);
const username = url.searchParams.get("username");

// Dynamic title and description based on username
const pageTitle = username 
  ? `@${username} - Zig Developer Profile | Zig Index`
  : `Zig Developer Profiles | Zig Index`;

const pageDescription = username
  ? `View @${username}'s Zig projects and contributions to the Zig ecosystem on Zig Index.`
  : `Discover ${uniqueOwners.length} developers maintaining ${stats.totalEntries} projects in the Zig ecosystem. View profiles, contributions, and projects.`;

const canonicalUrl = username 
  ? `${siteUrl}/u?username=${encodeURIComponent(username)}`
  : `${siteUrl}/u`;

const schema = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "ProfilePage",
      "@id": `${canonicalUrl}#profilepage`,
      "name": pageTitle,
      "description": pageDescription,
      "url": canonicalUrl,
      "isPartOf": {
        "@id": `${siteUrl}/#website`
      },
      "breadcrumb": {
        "@id": `${canonicalUrl}#breadcrumb`
      },
      "mainEntity": username ? {
        "@type": "Person",
        "name": username,
        "url": `https://github.com/${username}`,
        "sameAs": [`https://github.com/${username}`]
      } : {
        "@type": "ItemList",
        "name": "Zig Developers",
        "numberOfItems": uniqueOwners.length,
        "description": "Community developers contributing to the Zig ecosystem"
      }
    },
    {
      "@type": "BreadcrumbList",
      "@id": `${canonicalUrl}#breadcrumb`,
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": siteUrl
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": username ? `@${username}` : "Developer Profiles",
          "item": canonicalUrl
        }
      ]
    }
  ]
};
---

<Layout 
  title={pageTitle}
  description={pageDescription}
  keywords={username 
    ? `${username}, zig developer, github profile, zig contributor, zig packages, zig applications, zig index`
    : "zig developer, github profile, zig contributor, zig packages author, zig applications developer, zig community, zig index"
  }
  canonicalUrl={canonicalUrl}
  pageType="profile"
  schema={schema}
>
  <UserPageClient client:load registryEntries={registryEntries} />
</Layout>
