---
import Layout from "../layouts/Layout.astro";
import SearchPage from "../components/SearchPage";
import { getCollection } from "astro:content";

// Get query from URL
const query = Astro.url.searchParams.get("q") || "";

// Get projects from content collections
const repositories = await getCollection("repositories");

// Build search items array with comprehensive data for SEO
const searchItems = repositories.map((repo) => ({
  name: repo.data.name,
  owner: repo.data.owner,
  repo: repo.data.repo,
  description: repo.data.description,
  category: repo.data.category,
  type: repo.data.type,
  fullName: `${repo.data.owner}/${repo.data.repo}`,
}));

const siteUrl = import.meta.env.PUBLIC_SITE_URL || "https://zig-index.github.io";
const siteName = import.meta.env.PUBLIC_SITE_NAME || "Zig Index";

// Generate comprehensive SEO meta tags
const pageTitle = query 
  ? `Search "${query}" - Zig Projects | ${siteName}` 
  : `Search Zig Projects - Find Libraries, Tools & Software | ${siteName}`;

const pageDescription = query
  ? `Search results for "${query}" in ${siteName}. Discover ${searchItems.length}+ Zig projects, libraries, tools, and applications. Find the best Zig ecosystem resources for your projects.`
  : `Search ${searchItems.length}+ Zig projects, libraries, and applications. Find the perfect tools, modules, and software for your Zig programming projects. Unofficial, community-driven Zig project index.`;

// Generate keywords dynamically from search items
const categoryKeywords = [...new Set(searchItems.map(item => item.category))].filter(Boolean).join(", ");
const projectKeywords = searchItems.slice(0, 10).map(item => item.name).join(", ");
const pageKeywords = query 
  ? `${query}, zig search, zig packages, zig libraries, zig applications, ${categoryKeywords}, zig tools, zig ecosystem`
  : `zig packages search, zig libraries, zig applications, zig tools, ${categoryKeywords}, ${projectKeywords}, zig ecosystem, zig index`;

// Comprehensive schema for search results
const schema = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "SearchResultsPage",
      "@id": `${siteUrl}/search#searchresults`,
      "name": pageTitle,
      "description": pageDescription,
      "url": `${siteUrl}/search${query ? `?q=${encodeURIComponent(query)}` : ""}`,
      "isPartOf": {
        "@id": `${siteUrl}/#website`
      },
      "about": {
        "@type": "Thing",
        "name": "Zig Programming Language Ecosystem"
      },
      "mainEntity": {
        "@type": "ItemList",
        "numberOfItems": searchItems.length,
        "itemListElement": searchItems.slice(0, 20).map((item, index) => ({
          "@type": "ListItem",
          "position": index + 1,
          "item": {
            "@type": item.type === "package" ? "SoftwareSourceCode" : "SoftwareApplication",
            "@id": `${siteUrl}/repo?owner=${item.owner}&name=${item.repo}`,
            "name": item.name,
            "description": item.description || `${item.name} - A Zig ${item.type}`,
            "url": `${siteUrl}/repo?owner=${item.owner}&name=${item.repo}`,
            "codeRepository": `https://github.com/${item.owner}/${item.repo}`,
            "programmingLanguage": {
              "@type": "ComputerLanguage",
              "name": "Zig"
            },
            "applicationCategory": item.category || "Developer Tools"
          }
        }))
      }
    },
    {
      "@type": "WebSite",
      "@id": `${siteUrl}/#website`,
      "name": "Zig Index",
      "url": siteUrl,
      "description": "The community-driven registry for discovering Zig packages, libraries, and applications.",
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": `${siteUrl}/search?q={search_term_string}`
        },
        "query-input": "required name=search_term_string"
      }
    },
    {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": siteUrl
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Search",
          "item": `${siteUrl}/search`
        }
      ]
    }
  ]
};
---

<Layout 
  title={pageTitle}
  description={pageDescription}
  keywords={pageKeywords}
  canonicalUrl={`${siteUrl}/search`}
  schema={schema}
>
  <SearchPage client:load initialQuery={query} items={searchItems} />
</Layout>
